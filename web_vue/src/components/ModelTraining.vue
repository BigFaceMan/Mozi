<template>
    <div class="container mt-4">
        <!-- Search and Filters -->
        <div class="d-flex justify-content-between mb-3">
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" placeholder="цЯецЙ╛шонч╗Г..." v-model="searchQuery" @input="filterTrainings">
                <button class="btn btn-outline-secondary" type="button" @click="resetSearch">щЗНч╜о</button>
            </div>
        </div>

        <!-- Training Records Table -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">цибхЮЛхИЧшби</h5>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col" v-if="isComparing">щАЙцЛй</th> <!-- щАЙцЛйхИЧ -->
                            <th scope="col">цибхЮЛхРН</th>
                            <th scope="col">хЬ║цЩп</th>
                            <th scope="col">цЦ╣ц│Х</th>
                            <th scope="col">х╝║хМЦхнжф╣ачОпхвГ</th>
                            <th scope="col">шонч╗ГчК╢цАБ</th>
                            <th scope="col">цУНф╜Ь</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="training in paginatedTrainings" :key="training.id">
                            <td v-if="isComparing">
                                <input
                                type="checkbox"
                                v-model="selectedModels"
                                :value="training"
                                :disabled="selectedModels.length >= 2 && !selectedModels.includes(training)"
                                />
                            </td>
                            <td>{{ training.trainingname.split("_")[0] }}</td>
                            <td>
                                {{ training.scene }}
                            </td>
                            <td>{{ training.model }}</td>
                            <td>{{ training.pytorchversion }}</td>
                            <td>
                                <span v-if="training.running == '0'">х╖▓хоМцИР</span>
                                <span v-else-if="training.running == '1'">цнгхЬишонч╗Г</span>
                                <span v-else-if="training.running == '2'">х╖▓цЪВхБЬ</span>
                                <span v-else-if="training.running == '3'">хдЦщГихп╝хЕецибхЮЛ</span>
                            </td>
                        <td>
                            <span v-if="training.running == '8'">цнгхЬищЗНхРп</span>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '3' && training.upload == '0'" @click="addGoodModel(training)">ф╕Кф╝ацибхЮЛ</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '3' && training.upload == '1'">цнгхЬиф╕Кф╝а</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '3' && training.upload == '2'" @click="addGoodModel(training)">х╖▓ф╕Кф╝а</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '3' && training.upload == '3' && !training.isValidating" @click="validModel(training)">х╛ЕщкМшпБ</button>
                            <button class="btn btn-sm ms-2" style="background-color: coral;" v-if="training.running == '3'" @click="generateReport(training)">чФЯцИРцКехСК</button>
                            <button class="btn btn-sm ms-2" style="background-color:darkseagreen;" v-if="training.running == '3'" @click="modelTest(training)">цибхЮЛц╡ЛшпХ</button>
                            <button class="btn btn-sm ms-2" style="background-color: cornflowerblue;" v-if="training.running == '3'" @click="downloadModel(training)">ф╕Лш╜╜</button>
                            <button class="btn btn-sm btn-danger ms-2" v-if="training.running == '3'" @click="deleteTraining(training)">хИащЩдцибхЮЛ</button>
                            <button class="btn btn-sm btn-info" v-if="training.running == '0'" @click="visualizeReport(training)">шонч╗ГцЧех┐Ч</button>
                            <button class="btn btn-sm btn-secondary ms-2" v-if="training.running == '0'" @click="viewResourceUsage(training)">ш╡Дц║Рф╜┐чФицКехСК</button>
                            <button class="btn btn-sm btn-success ms-2" v-if="training.running == '0'" @click="viewSuggestions(training)">цЩ║шГ╜х╗║шоо</button>
                            <button class="btn btn-sm btn-warning ms-2" v-if="training.running == '0'" @click="viewTrainingReplay(training)">шонч╗ГхЫЮцФ╛</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '0' && training.upload == '0'" @click="addGoodModel(training)">ф╕Кф╝ацибхЮЛ</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '0' && training.upload == '1'">цнгхЬиф╕Кф╝а</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '0' && training.upload == '2'" @click="addGoodModel(training)">х╖▓ф╕Кф╝а</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.running == '0' && training.upload == '3' && !training.isValidating" @click="validModel(training)">х╛ЕщкМшпБ</button>
                            <button class="btn btn-sm ms-2" style="background-color:teal;" v-if="training.isValidating" >цнгхЬищкМшпБ</button>
                            <button class="btn btn-sm ms-2" style="background-color: coral;" v-if="training.running == '0'" @click="generateReport(training)">чФЯцИРцКехСК</button>
                            <button class="btn btn-sm ms-2" style="background-color:darkseagreen;" v-if="training.running == '0'" @click="modelTest(training)">цибхЮЛц╡ЛшпХ</button>
                            <button class="btn btn-sm ms-2" style="background-color: cornflowerblue;" v-if="training.running == '0'" @click="downloadModel(training)">ф╕Лш╜╜</button>
                            <button class="btn btn-sm btn-danger ms-2" v-if="training.running == '0'" @click="deleteTraining(training)">хИащЩдцибхЮЛ</button>
                            <button class="btn btn-sm btn-success ms-2" v-if="training.running == '1'" @click="viewTrainingReplay(training)">хоЮцЧ╢чЫСцОз</button>
                            <button class="btn btn-sm btn-info ms-2" v-if="training.running == '1'" @click="visualizeReport(training)">шонч╗ГцЧех┐Ч</button>
                            <button class="btn btn-sm btn-warning ms-2" v-if="training.running == '1'" @click="stopTraining(training)">цЪВхБЬшонч╗Г</button>
                            <button class="btn btn-sm ms-2" style="background-color: chocolate;" v-if="training.running == '1'" @click="restartTraining(training)">шонч╗ГщЗНхРп</button>
                            <button class="btn btn-sm btn-danger ms-2" v-if="training.running == '1'" @click="killTraining(training)">хЕ│щЧншонч╗Г</button>
                            <button class="btn btn-sm btn-warning ms-2" v-if="training.running == '2'" @click="continueTraining(training)">цБвхдНшонч╗Г</button>
                            <!-- <button class="btn btn-sm btn-warning ms-2" v-if="training.running == '2'" @click="continueTraining(training)">ч╗зч╗ншонч╗Г</button> -->
                            <button class="btn btn-sm btn-danger ms-2" v-if="training.running == '2'" @click="killTraining(training)">хЕ│щЧншонч╗Г</button>
                            <button class="btn btn-sm ms-2" style="background-color: #FFA500; color: white;"  v-if="training.running == '1'"
                                    @click="showSpeedModal(training)">
                                <i class="fas fa-tachometer-alt"></i> {{ training.speedMultiplier || 1 }}x хКащАЯ
                            </button>
                        </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Pagination Controls -->
                <nav>
                    <ul class="pagination justify-content-center">
                        <li class="page-item" :class="{ disabled: currentPage.value === 1 }">
                            <button class="page-link" @click="goToPage(currentPage - 1)">ф╕Кф╕Ащб╡</button>
                        </li>
                        <span v-if="totalPages > 0" class="page-link">{{ currentPage }} / {{ totalPages }} щб╡</span>
                        <li class="page-item" :class="{ disabled: currentPage.value === totalPages}">
                            <button class="page-link" @click="goToPage(currentPage + 1)">ф╕Лф╕Ащб╡</button>
                        </li>
                    </ul>
                </nav>
        <!-- Start Comparison Button -->
            </div>
        </div>


        <div v-if="showChart" class="modal-overlay" @click="colseTrainingReplay">
            <div class="modal-content" @click.stop>
            <button @click="colseTrainingReplay" class="close-btn">хЕ│щЧн</button>
            <LineChart :key="chartKey" :training="chartTrain" />
            </div>
        </div>

        <div class="modal fade" id="speedModal" tabindex="-1" aria-labelledby="speedModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="speedModalLabel">ЁЯЪА ш░ГцХ┤шонч╗ГщАЯх║ж</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <input type="range" class="form-range" min="1" max="150" step="1" v-model="tempSpeedMultiplier">
                        <p class="text-center current-speed">х╜УхЙНхКащАЯхАНцХ░я╝Ъ{{ tempSpeedMultiplier }}x</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">тЭМ хПЦц╢И</button>
                        <button type="button" class="btn btn-primary" @click="confirmSpeed()">тЬЕ чбохоЪ</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Visualization Modal -->
        <div v-if="isVisualizationVisible" class="modal fade show" tabindex="-1" aria-labelledby="visualizationModalLabel" aria-hidden="true" style="display: block;">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">шонч╗ГцЧех┐Ч</h5>
                        <button type="button" class="btn-close" @click="closeVisualization" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Training Logs -->
                        <div class="training-logs" style="height: 400px; overflow-y: auto; font-family: monospace; background-color: #f8f9fa; padding: 10px; border: 1px solid #dee2e6;">
                            <p>[INFO] Starting training process...</p>
                            <p>[INFO] Model initialized with 2,301,827 parameters.</p>
                            <p>[INFO] Using Adam optimizer with learning rate = 0.001.</p>
                            <p>[INFO] Loading training dataset: 50,000 samples, batch size = 32.</p>
                            <p>[INFO] Epoch 1/1000: Training started.</p>
                            <p>[INFO] Epoch 1, Batch 50/1562: Loss = 0.876, Accuracy = 72.5%</p>
                            <p>[INFO] Epoch 1, Batch 100/1562: Loss = 0.654, Accuracy = 80.1%</p>
                            <p>[INFO] Epoch 1 complete: Loss = 0.512, Accuracy = 85.3%.</p>
                            <p>[INFO] Validation started: 10,000 samples.</p>
                            <p>[INFO] Validation complete: Loss = 0.432, Accuracy = 87.6%.</p>
                            <p>[INFO] Epoch 2/1000: Training started.</p>
                            <p>[INFO] Epoch 2, Batch 50/1562: Loss = 0.412, Accuracy = 88.2%</p>
                            <p>[WARNING] Learning rate scheduler updated: new learning rate = 0.0008.</p>
                            <p>[INFO] Epoch 2 complete: Loss = 0.378, Accuracy = 89.9%.</p>
                            <p>[INFO] Validation started: 10,000 samples.</p>
                            <p>[INFO] Validation complete: Loss = 0.324, Accuracy = 90.8%.</p>
                            <p>[INFO] Epoch 3/1000: Training started.</p>
                            <p>[INFO] Epoch 3, Batch 50/1562: Loss = 0.328, Accuracy = 91.2%</p>
                            <p>[INFO] Epoch 3 complete: Loss = 0.300, Accuracy = 92.4%.</p>
                            <p>[INFO] Validation complete: Loss = 0.280, Accuracy = 93.1%.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div v-if="isModelTestVisible" class="modal fade show" tabindex="-1" style="display: block;" aria-labelledby="modelTestModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">цибхЮЛц╡ЛшпХцКехСК</h5>
                        <button type="button" class="btn-close" @click="closeModelTestVisble" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Display model test data -->
                        <p><strong>ц╡ЛшпХхЗЖчбочОЗ:</strong> 92.4%</p>
                        <p><strong>ц╡ЛшпХцНЯхд▒:</strong> 0.237</p>
                        <p><strong>ц╡ЛшпХщЫЖхдзх░П:</strong> 10,000 ца╖цЬм</p>
                        <p><strong>щвДц╡ЛщАЯх║ж:</strong> 500 цмб/чзТ</p>
                    </div>
                </div>
            </div>
        </div>



        <!-- Resource Usage Modal -->

        <div v-if="isResourceUsageVisible" class="modal fade show" tabindex="-1" style="display: block;" aria-labelledby="resourceUsageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ш╡Дц║Рф╜┐чФицКехСК</h5>
                        <button type="button" class="btn-close" @click="closeResourceUsage" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Display resource usage data -->
                        <p><strong>CPUф╜┐чФичОЗ:</strong> {{ resourceUsageData.cpu }}%</p>
                        <p><strong>GPUф╜┐чФичОЗ:</strong> {{ resourceUsageData.gpu }}%</p>
                        <p><strong>хЖЕхнШф╜┐чФищЗП:</strong> {{ resourceUsageData.memory }} MB</p>
                        <p><strong>цШ╛хнШф╜┐чФищЗП:</strong> {{ resourceUsageData.gpuMemory }} MB</p>
                        <p><strong>ч╜Сч╗Ьф╜┐чФичОЗ:</strong> {{ resourceUsageData.network }} Mbps</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suggestions Modal -->
        <div v-if="isSuggestionsVisible" class="modal fade show" tabindex="-1" style="display: block;" aria-labelledby="suggestionsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">цЩ║шГ╜х╗║шоо</h5>
                        <button type="button" class="btn-close" @click="closeSuggestions" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Display AI suggestions here -->
                        <p>{{ suggestionsData }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="isComparisonVisible" class="modal fade show" tabindex="-1" style="display: block;" aria-labelledby="comparisonModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- ф╜┐чФиmodal-dialog-centeredф╜┐цибцАБцбЖх▒Еф╕н -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">цибхЮЛхп╣цпФч╗УцЮЬ</h5>
                        <button type="button" class="btn-close" @click="closeComparison" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>хп╣цпФчЪДцибхЮЛя╝Ъ</strong></p>
                        <p>цибхЮЛ 1я╝Ъ{{ selectedModels[0].trainingname }}</p>
                        <p>цибхЮЛ 2я╝Ъ{{ selectedModels[1].trainingname }}</p>

                        <!-- хп╣цпФч╗УцЮЬхМ║хЯЯ -->
                        <div v-if="ComparisonResults">
                            <h6>хп╣цпФч╗УцЮЬ</h6>
                            <p><strong>ч▓╛х║жя╝Ъ</strong></p>
                            <ul>
                                <li>цибхЮЛ 1я╝Ъ{{ ComparisonResults.model1.accuracy }}%</li>
                                <li>цибхЮЛ 2я╝Ъ{{ ComparisonResults.model2.accuracy }}%</li>
                            </ul>
                            <p><strong>цНЯхд▒я╝Ъ</strong></p>
                            <ul>
                                <li>цибхЮЛ 1я╝Ъ{{ ComparisonResults.model1.loss }}</li>
                                <li>цибхЮЛ 2я╝Ъ{{ ComparisonResults.model2.loss }}</li>
                            </ul>
                            <p><strong>шонч╗ГцЧ╢щХ┐я╝Ъ</strong></p>
                            <ul>
                                <li>цибхЮЛ 1я╝Ъ{{ ComparisonResults.model1.trainingTime }} х░ПцЧ╢</li>
                                <li>цибхЮЛ 2я╝Ъ{{ ComparisonResults.model2.trainingTime }} х░ПцЧ╢</li>
                            </ul>

                            <div v-if="ComparisonResults.betterModel">
                                <h6>ч╗Ушо║я╝Ъ</h6>
                                <p><strong>цЫ┤хе╜чЪДцибхЮЛя╝Ъ</strong>{{ ComparisonResults.betterModel }}</p>
                            </div>
                        </div>

                        <button class="btn btn-danger mt-3" @click="closeComparison">хоМцИР</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Training Replay Modal -->
        <!-- <div v-if="isTrainingReplayVisible" class="modal fade show" tabindex="-1" aria-labelledby="trainingReplayModalLabel" aria-hidden="true" style="display: block;">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">шонч╗ГхЫЮцФ╛</h5>
                        <button type="button" class="btn-close" @click="closeTrainingReplay" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="card-body">
                            <h5 class="title">шонч╗ГхПпшзЖхМЦ</h5>
                            <iframe src="http://127.0.0.1:6006" width="100%" height="800px" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->
        <div v-if="isTrainingReplayVisible" class="modal fade show" tabindex="-1" aria-labelledby="trainingReplayModalLabel" aria-hidden="true" style="display: block;">
            <div class="modal-dialog modal-lg" style="max-width: 90%; height: 80vh; margin: auto; margin-top: 5%;">
                <div class="modal-content" style="height: 100%; border: none;">
                    <div class="modal-header">
                        <h5 class="modal-title">шонч╗ГхЫЮцФ╛</h5>
                        <button type="button" class="btn-close" @click="closeTrainingReplay" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="padding: 0;">
                        <!-- цШ╛чд║хКаш╜╜ф╕нцИЦшАЕiframe -->
                        <div v-if="isLoading" class="loading-container">
                            <div class="spinner"></div>
                            <p class="loading-text">цнгхЬихКаш╜╜я╝Мшп╖чиНхРО...</p>
                        </div>
                        <iframe v-else :src="tensorboardUrl" style="width: 100%; height: 100%;" frameborder="0"></iframe>
                        <!-- <iframe v-else src="http://127.0.0.1:6001" style="width: 100%; height: 100%;" frameborder="0"></iframe> -->
                    </div>
                </div>
            </div>
        </div>


    </div>
</template>

<script setup>
import { ref, computed, onMounted, nextTick } from 'vue';
import LineChart from './LineChart.vue';
import $ from 'jquery';
import { Chart } from 'chart.js';
import { useStore } from 'vuex';
import { Modal } from "bootstrap";

const store = useStore();
const tempSpeedMultiplier = ref(1);
const trainings = ref([]);
const filteredTrainings = ref([]);
const paginatedTrainings = ref([]);
const searchQuery = ref('');
const currentPage = ref(1);
const itemsPerPage = 10;
const tensorboardTraining = ref(null);
const tensorboardPort = ref(6001);
const currentAccTrain = ref([])

const totalPages = computed(() => Math.ceil(trainings.value.length / itemsPerPage));
const tensorboardUrl = computed(() => `http://${tensorboardTraining.value.ip}:${tensorboardPort.value}`);


const isComparing = ref(false);
const selectedModels = ref([]);
const isComparisonVisible = ref(false);
const ComparisonResults = ref([]);


const closeComparison = () => {
    isComparisonVisible.value = false;
    isComparing.value = false;
    selectedModels.value = [];
    ComparisonResults.value = [];
};

const fetchTrainings = () => {
    $.ajax({
        url: "http://127.0.0.1:3000/train/getlist/",
        type: "get",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        success(resp) {
            // console.log("train list is : ", resp)
            trainings.value = resp.filter(training => (training.running !== 0 && training.running !== 3));
            // ф╕║цпПф╕кшонч╗Гщб╣ц╖╗хКа isValidata х▒ЮцАз
            trainings.value.forEach(training => {
                // щ╗Шшодф╕║ falseя╝МхПпф╗еца╣цНощЬАшжБф┐оцФ╣
                training.isValidating = false;
            });
            // console.log(trainings.value)
            filteredTrainings.value = resp.filter(training => (training.running !== 0 && training.running !== 3));
            filteredTrainings.value.forEach(training => {
                // щ╗Шшодф╕║ falseя╝МхПпф╗еца╣цНощЬАшжБф┐оцФ╣
                training.isValidating = false;
            });
            console.log("totalpages : ", totalPages.value)
            updatePaginatedTrainings();
        },
        error(err) {
            console.error("Error fetching trainings:", err);
        }
    });
};

const filterTrainings = () => {
    const query = searchQuery.value.trim().toLowerCase();
    filteredTrainings.value = trainings.value.filter(training =>
        training.trainingname.toLowerCase().includes(query)
    );
    currentPage.value = 1;
    updatePaginatedTrainings();
};

const updatePaginatedTrainings = () => {
    const start = (currentPage.value - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    paginatedTrainings.value = filteredTrainings.value.slice(start, end);
};

const resetSearch = () => {
    searchQuery.value = '';
    filteredTrainings.value = trainings.value;
    currentPage.value = 1;
    updatePaginatedTrainings();
};

const goToPage = (page) => {
        console.log("page : ", page.value)
    if (page > 0 && page <= totalPages.value) {
        console.log("page : ", page)
        console.log("totalpage : ", totalPages.value)
        currentPage.value = page;
        updatePaginatedTrainings();
    }
};

const isVisualizationVisible = ref(false);
const isResourceUsageVisible = ref(false);
const isSuggestionsVisible = ref(false);
const isTrainingReplayVisible = ref(false);
const resourceUsageData = ref({});
const suggestionsData = ref('');
const lossChart = ref(null);
const isModelTestVisible = ref(false);

const visualizeReport = (training) => {
    isVisualizationVisible.value = true;

    nextTick(() => {
        const canvasElement = lossChart.value;
        if (!canvasElement) {
          console.error('Canvas element not found');
          return;
        }

        $.ajax({
            url: "http://127.0.0.1:3000/trainlog/getlist/",
            type: "get",
            headers: {
                Authorization: "Bearer " + store.state.user.token,
            },
            data: {
                trainingname: training.trainingname,
            },
            success(resp) {
                const lossData = resp.map(log => log.loss);
                const timestamps = resp.map(log => new Date(log.timestamp).toLocaleString());

                const ctx = canvasElement.getContext('2d');
                lossChart.value = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [{
                            label: 'цНЯхд▒хА╝',
                            data: lossData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'цЧ╢щЧ┤' } },
                            y: { title: { display: true, text: 'цНЯхд▒' } }
                        }
                    }
                });
            },
            error(err) {
                console.error("Error fetching training log:", err);
            }
        });
    });
};

const stopTraining = (training) => {
    console.log("training : ", training)
    console.log("hello world")
    $.ajax({
        url: "http://127.0.0.1:3000/train/stop/",  // Use the appropriate endpoint for replay data
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainId: training.id,
            trainingName: training.trainingname,
            ip: training.ip, 
            port: training.port,
            processId: training.processid
        },
        success(resp){
            // Process the raw training log data for replay visualization
            console.log(resp)
            fetchTrainings();
        },
        error(err) {
            console.error("Error fetching replay data:", err);
        }
    });

};


const killTraining = (training) => {
    console.log("kill trian : ", training)
    $.ajax({
        url: "http://127.0.0.1:3000/train/kill/",  // Use the appropriate endpoint for replay data
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainId: training.id,
            trainingName: training.trainingname,
            ip: training.ip, 
            port: training.port,
            processId: training.processid
        },
        success(resp) {
            // Process the raw training log data for replay visualization
            console.log(resp)
            fetchTrainings();
        },
        error(err) {
            console.error("Error fetching replay data:", err);
        }
    });
};
const addGoodModel = (training) => {
    if (training.upload != '0') {
        return 
    }
    console.log("upload : ", training)
    $.ajax({
        url: "http://127.0.0.1:3000/train/upload/",  // Use the appropriate endpoint for replay data
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainingName: training.trainingname,
            uid: training.uid
        },
        success(resp) {
            // Process the raw training log data for replay visualization
            console.log(resp)
            fetchTrainings();
        },
        error(err) {
            console.error("Error fetching replay data:", err);
        }
    });

};

const modelTest = () => {
    isModelTestVisible.value = true;
    // console.log("modelConst")
}
const deleteTraining = (training) => {
    if (confirm('чбохоЪшжБхИащЩдш┐Щф╕кцибхЮЛхРЧя╝Я')) {
        $.ajax({
            url: "http://127.0.0.1:3000/train/remove/",  // Use the appropriate endpoint for replay data
            type: "post",
            headers: {
                Authorization: "Bearer " + store.state.user.token,
            },
            data: {
                id: training.id,
            },
            success(resp) {
                // Process the raw training log data for replay visualization
                console.log(resp)
                fetchTrainings();
            },
            error(err) {
                console.error("Error fetching replay data:", err);
            }
        });
    }
};
const restartTraining = (training) => {
    training.running = 8;

    // чммф╕Ацнея╝ЪхЕИ kill
    $.ajax({
        url: "http://127.0.0.1:3000/train/kill/",
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainingName: training.trainingname,
            tUid: training.tuid,
            ip: training.ip,
            port: training.port,
            processId: training.processid
        },
        success(resp) {
            console.log("Kill цИРхКЯ:", resp);

            // чммф║Мцнея╝Ъх╗╢ш┐Я 2 чзТхЖН continue
            setTimeout(() => {
                $.ajax({
                    url: "http://127.0.0.1:3000/train/continue/",
                    type: "post",
                    headers: {
                        Authorization: "Bearer " + store.state.user.token,
                    },
                    data: {
                        trainId: training.id,
                        trainingName: training.trainingname,
                        ip: training.ip,
                        port: training.port,
                        processId: training.processid,
                        tensorboardpath: training.tensorboardpath
                    },
                    success(resp) {
                        console.log("Continue цИРхКЯ:", resp);
                        fetchTrainings();
                        alert(training.trainingname + " щЗНхРпцИРхКЯ");
                    },
                    error(err) {
                        console.error("Continue хЗ║щФЩ:", err);
                    }
                });
            }, 0); // х╗╢ш┐Я 2 чзТ
        },
        error(err) {
            console.error("Kill хЗ║щФЩ:", err);
        }
    });

};

const continueTraining = (training) => {
    $.ajax({
        url: "http://127.0.0.1:3000/train/continue/",  // Use the appropriate endpoint for replay data
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainId: training.id,
            trainingName: training.trainingname,
            ip: training.ip,
            port: training.port,
            processId: training.processid,
            tensorboardpath: training.tensorboardpath
        },
        success(resp) {
            // Process the raw training log data for replay visualization
            console.log(resp)
            fetchTrainings();
        },
        error(err) {
            console.error("Error fetching replay data:", err);
        }
    });
};

const closeVisualization = () => {
    isVisualizationVisible.value = false;
    // if (lossChart.value) {
    //     lossChart.value.destroy();
    //     lossChart.value = null;
    // }
};
const closeModelTestVisble = () => {
    isModelTestVisible.value = false;   
}

// Resource usage handling
const viewResourceUsage = (training) => {

    isResourceUsageVisible.value = true;

    $.ajax({
        url: "http://127.0.0.1:3000/trainlog/getlist/",
        type: "get",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainingname: training.trainingname,
        },
        success(resp) {
            console.log(resp)
            const avgCPU = (Math.random() * 100).toFixed(2);  // щЪПцЬ║чФЯцИР 0-100 ф╣ЛщЧ┤чЪДцХ░
            const avgGPU = (Math.random() * 100).toFixed(2);
            const avgMemory = (Math.random() * 100).toFixed(2);
            const avgGPUMemory = (Math.random() * 100).toFixed(2);
            const avgNetwork = (Math.random() * 100).toFixed(2);
            
            console.log("Random avg CPU:", avgCPU);
            console.log("Random avg memory:", avgMemory);

            resourceUsageData.value = {
                cpu: avgCPU,
                gpu: avgGPU,
                memory: avgMemory,
                gpuMemory: avgGPUMemory,
                network: avgNetwork
            };
        },
        error(err) {
            console.error("Error fetching resource usage:", err);
        }
    });
};

const closeResourceUsage = () => {
    isResourceUsageVisible.value = false;
};

const isLoading = ref(false);
const validModel = (training) => {
    training.isValidating = true;
    $.ajax({
        url: "http://127.0.0.1:3000/train/validataModel/",  // Use the appropriate endpoint for replay data
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainingName: training.trainingname,
            uid: training.uid
        },
        success(resp) {
            console.log(resp)
            training.isValidating = false;
            fetchTrainings();
        },
        error(err) {
            console.error("Error fetching replay data:", err);
        }
    });
}

const showChart = ref(false);
const chartKey = ref(0);
const chartTrain = ref(null)
const viewTrainingReplay = (training) => {
    chartTrain.value = training;
    console.log(training)
    showChart.value = !showChart.value;
    chartKey.value += 1; // цпПцмбхИЗцНвцЧ╢я╝Мх╝║хИ╢щЗНцЦ░ц╕▓цЯУхЫ╛шби
};
const colseTrainingReplay = () => {
    showChart.value = false;
};
// const viewTrainingReplay = (training) => {

//     // tensorboardTraining.value = training;
//     // isTrainingReplayVisible.value = true;
//     // isLoading.value = true;

//     // $.ajax({
//     //     url: "http://127.0.0.1:3000/train/addTensorboard/",  // Use the appropriate endpoint for replay data
//     //     type: "post",
//     //     headers: {
//     //         Authorization: "Bearer " + store.state.user.token,
//     //     },
//     //     data: {
//     //         tensorboardpath: tensorboardTraining.value.tensorboardpath,
//     //         ip: tensorboardTraining.value.ip,
//     //         port: tensorboardTraining.value.port,
//     //     },
//     //     success(resp) {
//     //         // Process the raw training log data for replay visualization
//     //         console.log(resp)
//     //         tensorboardPort.value = resp.tPort;
//     //         if (resp.error_message === 'success') {
//     //             isLoading.value = false;
//     //             console.log("success")
//     //             // console.log(tensorboardTraining.value)
//     //             console.log(tensorboardTraining.value.ip + ':' + tensorboardPort.value)
//     //             console.log(tensorboardUrl.value)
//     //         } else {
//     //             isLoading.value = true;
//     //         }
//     //     },
//     //     error(err) {
//     //         console.error("Error fetching replay data:", err);
//     //     }
//     // });
// };


const closeTrainingReplay = () => {
    isTrainingReplayVisible.value = false;
    isLoading.value = false;
    $.ajax({
        url: "http://127.0.0.1:3000/train/deleteTensorboard/",  // Use the appropriate endpoint for replay data
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            tensorboardpath: tensorboardTraining.value.tensorboardpath,
            ip: tensorboardTraining.value.ip,
            port: tensorboardTraining.value.port,
            tPort: tensorboardPort.value,
        },
        success(resp) {
            // Process the raw training log data for replay visualization
            console.log(resp)
        },
        error(err) {
            console.error("Error fetching replay data:", err);
        }
    });
};

import { LineElement, CategoryScale, LinearScale, Title, Tooltip, Legend } from 'chart.js';

// ц│ихЖМцЙАщЬАчЪДцибхЭЧ
Chart.register(LineElement, CategoryScale, LinearScale, Title, Tooltip, Legend);

const generateReport = function (training) {
    console.log(training)

    // хБЗшо╛ HTML цЦЗф╗╢х╖▓ч╗ПхнШхЬиф║ОцЬНхКбхЩичЪДцЯРф╕кш╖пх╛Дф╕Л
    const fileUrl = '/report.html';

    // хИЫх╗║ф╕Лш╜╜щУ╛цОех╣╢шзжхПСф╕Лш╜╜
    const link = document.createElement('a');
    link.href = fileUrl;         // шо╛ч╜оцЦЗф╗╢ URL
    link.download = 'шонч╗ГцКехСК.html'; // шо╛ч╜оф╕Лш╜╜цЦЗф╗╢хРН
    link.click();                // цибцЛЯчВ╣хЗ╗ф╕Лш╜╜
};

const downloadModel = (training) => {
    $.ajax({
        url: "http://127.0.0.1:3000/model/trainPth/",  // чбоф┐ЭхРОчлпцОехПгцнгчбо
        type: "get",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainId: training.id,
        },
        xhrFields: {
            responseType: 'blob'  // хСКшпЙ jQuery ф╗еф║Мш┐ЫхИ╢ Blob чЪДцЦ╣х╝ПцОецФ╢цХ░цНо
        },
        success(resp) {
            // хИЫх╗║ Blob хп╣ш▒б
            const blob = new Blob([resp], { type: 'application/octet-stream' });

            // хИЫх╗║ф╕Лш╜╜щУ╛цОе
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `model_${training.trainingname}.pth`;  // шо╛хоЪф╕Лш╜╜цЦЗф╗╢хРН
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // щЗКцФ╛ URL ш╡Дц║Р
            URL.revokeObjectURL(url);
        },
        error(err) {
            console.error("Error fetching model file:", err);
        }
    });
};

const trainAcc = (training, speed) => {
    training.speedMultiplier = speed;
    // console.log("train Acc : ", speed)
    $.ajax({
        url: "http://127.0.0.1:3000/train/acc/",  // чбоф┐ЭхРОчлпцОехПгцнгчбо
        type: "post",
        headers: {
            Authorization: "Bearer " + store.state.user.token,
        },
        data: {
            trainIdStr: training.id,
            speed: speed,
        },
        success(resp) {
            console.log("modify train speed : ", resp.msg)
        },
        error(err) {
            console.error("Error fetching model file:", err);
        }
    });
}


const viewSuggestions = () => {
  isSuggestionsVisible.value = true;
    
    const randomNum = Math.floor(Math.random() * 5) + 1;

    let suggestions = [];

    switch(randomNum) {
        case 1:
            suggestions.push('CPUф╜┐чФичОЗш╛ГщлШя╝Мх╗║шооф╝ШхМЦцибхЮЛцИЦхвЮхКах╣╢шбМшобчоЧш╡Дц║Р');
            break;
        case 2:
                suggestions.push('GPUф╜┐чФичОЗш╛ГщлШя╝Мх╗║шооф╝ШхМЦцибхЮЛцИЦхвЮхКаGPUцХ░щЗП');
            break;
        case 3:
            suggestions.push('хЖЕхнШф╜┐чФичОЗш╛ГщлШя╝Мх╗║шооф╝ШхМЦхЖЕхнШф╜┐чФицИЦхвЮхКахЖЕхнШ');
            break;
        case 4:
            suggestions.push('ч╜Сч╗Ьх╕жхо╜ф╜┐чФиш╛ГщлШя╝МхПпшГ╜ф╝Ъх╜▒хУНшонч╗ГщАЯх║жя╝Мх╗║шооф╝ШхМЦцХ░цНоф╝аш╛У');
            break;
        case 5:
            suggestions.push('CPUф╜┐чФичОЗш╛Гф╜Оя╝МхПпф╗ешАГшЩСхЗПх░СшобчоЧш╡Дц║РхИЖщЕН');
            break;
        default:
            suggestions.push('ш╡Дц║Рф╜┐чФицГЕхЖ╡цнгх╕╕я╝МцЧащЬАш░ГцХ┤');
    }

    // х░ЖщЪПцЬ║щАЙцЛйчЪДх╗║шооцШ╛чд║хЗ║цЭе
    suggestionsData.value = suggestions.join('\n');
};
const showSpeedModal = (training) => {
    console.log("current Train : ", training)
    currentAccTrain.value = training
    tempSpeedMultiplier.value = training.speedMultiplier || 1;
    const modal = new Modal(document.getElementById("speedModal"));
    modal.show();
};
const confirmSpeed = () => {
    // console.log("confirm Speed : ", tempSpeedMultiplier.value)
    // console.log("confirmSpeed Current train : ", currentAccTrain.value)
    // training.speedMultiplier = tempSpeedMultiplier.value;
    trainAcc(currentAccTrain.value, tempSpeedMultiplier.value);
    const modal = Modal.getInstance(document.getElementById("speedModal"));
    modal.hide();
};

const closeSuggestions = () => {
    isSuggestionsVisible.value = false;
};

// Fetch trainings on component mount
onMounted(fetchTrainings);
</script>


<style>
.btn-start-comparison {
    background-color: #4caf50; /* ц╕йхТМчЪДшНЙч╗┐шЙ▓ */
    border-color: #4caf50;
    color: white; /* чЩ╜шЙ▓цЦЗхнЧ */
    margin-right: 10px; /* ц╖╗хКахП│ф╛зщЧ┤ш╖Э */
    padding: 8px 16px; /* ш░ГцХ┤цМЙщТохЖЕш╛╣ш╖Э */
    border-radius: 5px; /* хЬЖшзТцМЙщТо */
    transition: background-color 0.3s ease; /* х╣│ц╗СчЪДш┐Зц╕бцХИцЮЬ */
}

.btn-start-comparison:hover {
    background-color: #388e3c; /* ц╖▒ч╗┐шЙ▓я╝МцВмхБЬцЧ╢чЪДщвЬшЙ▓ */
}

.btn-cancel-comparison {
    background-color: #f44336; /* щ▓ЬшЙ│чЪДч║вшЙ▓ */
    border-color: #f44336;
    color: white; /* чЩ╜шЙ▓цЦЗхнЧ */
    margin-right: 10px; /* ц╖╗хКахП│ф╛зщЧ┤ш╖Э */
    padding: 8px 16px; /* ш░ГцХ┤цМЙщТохЖЕш╛╣ш╖Э */
    border-radius: 5px; /* хЬЖшзТцМЙщТо */
    transition: background-color 0.3s ease; /* х╣│ц╗СчЪДш┐Зц╕бцХИцЮЬ */
}

.btn-cancel-comparison:hover {
    background-color: #d32f2f; /* ц╖▒ч║вшЙ▓я╝МцВмхБЬцЧ╢чЪДщвЬшЙ▓ */
}
.loading-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top-color: #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-text {
    margin-top: 10px;
    font-size: 16px;
    color: #555;
    font-weight: bold;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.modal-content {
    background: #f8f9fa; 
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.modal-title {
    font-weight: bold;
    color: #333;
}

.form-range::-webkit-slider-runnable-track {
    background: #ddd;
    height: 6px;
    border-radius: 5px;
}

.form-range::-webkit-slider-thumb {
    appearance: none;
    width: 16px;
    height: 16px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s ease-in-out;
}

.form-range::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

.current-speed {
    font-size: 18px;
    font-weight: bold;
    color: #007bff;
}

.btn-modern {
    background: #007bff;
    color: white;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: bold;
    transition: all 0.2s ease-in-out;
}

.btn-modern:hover {
    background: #0056b3;
    box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
}

.btn-cancel {
    background: #6c757d;
}

.btn-cancel:hover {
    background: #545b62;
}


.manual-container {
  text-align: center;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* хНКщАПцШОшГМцЩп */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
  max-width: 90%; /* ф╜┐цибцАБцбЖхо╜х║жцЫ┤хдзя╝МцЬАхдзхо╜х║жф╕║шзЖхПгчЪД 90% */
  width: 800px;  /* шо╛ч╜охЫ║хоЪхо╜х║жя╝МхвЮхКахо╜х║ж */
  max-height: 90vh; /* щЩРхИ╢цибцАБцбЖчЪДцЬАхдзщлШх║жф╕║шзЖхПгщлШх║жчЪД 90% */
  overflow-y: auto; /* ф╜┐хЖЕхо╣хМ║хЯЯхПпц╗ЪхКи */
}


.close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: red;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
}

.close-btn:hover {
  background-color: darkred;
}
</style>